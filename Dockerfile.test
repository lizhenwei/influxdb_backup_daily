FROM alpine:3.22

# 设置环境变量默认值
ENV ORG_NAME=my-org
ENV MAIN_BUCKET_NAME=my-bucket
ENV INFLUX_HOST=http://localhost:8086
ENV BACKUP_DIR=/backup
# 注意：INFLUX_TOKEN需要在运行容器时通过 -e 参数提供

# 安装必要的软件包
RUN apk add --no-cache curl jq tar bash wget

# 安装 InfluxDB CLI
ENV INFLUX_VERSION="2.7.5"
RUN wget https://dl.influxdata.com/influxdb/releases/influxdb2-client-${INFLUX_VERSION}-linux-amd64.tar.gz -O /tmp/influx.tar.gz \
    && mkdir -p /tmp/influx \
    && tar -zxvf /tmp/influx.tar.gz -C /tmp/influx \
    && cp /tmp/influx/influx /usr/local/bin/ \
    && chmod +x /usr/local/bin/influx \
    && rm -rf /tmp/influx /tmp/influx.tar.gz

# 创建备份目录
RUN mkdir -p $BACKUP_DIR && chmod 777 $BACKUP_DIR

# 拷贝数据生成脚本
COPY generate_test_data.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/generate_test_data.sh

# 创建日志文件
RUN touch /var/log/influx_test_data.log && chmod 666 /var/log/influx_test_data.log

# 配置 crontab：每分钟执行一次数据生成脚本，日志写入文件并同时输出到 stdout
RUN echo "* * * * * /usr/local/bin/generate_test_data.sh 2>&1 | tee -a /var/log/influx_test_data.log >&2" > /etc/crontabs/root

# 设置工作目录
WORKDIR $BACKUP_DIR

# 启动 cron（前台模式，日志级别2）
CMD ["crond", "-f", "-l", "2"]
